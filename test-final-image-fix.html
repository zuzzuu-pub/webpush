<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Final Socket.IO Image Fix Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
      }
      button {
        padding: 10px 20px;
        margin: 10px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      .log {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        font-family: monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
      .info {
        color: blue;
      }
    </style>
  </head>
  <body>
    <h1>üîß Final Socket.IO Image Fix Test</h1>
    <p>Testing enhanced service worker image handling</p>

    <button onclick="testWithYourImageURL()">Test with Your Image URL</button>
    <button onclick="testWithDifferentImage()">
      Test with Different Image
    </button>
    <button onclick="testWithoutImage()">Test without Image</button>
    <button onclick="clearLogs()">Clear Logs</button>

    <div id="log" class="log"></div>

    <script>
      let logs = [];

      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const entry = `[${timestamp}] ${message}`;
        logs.push({ entry, type });
        updateLog();
        console.log(entry);
      }

      function updateLog() {
        const logDiv = document.getElementById("log");
        logDiv.innerHTML = logs
          .map(({ entry, type }) => `<div class="${type}">${entry}</div>`)
          .join("");
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function clearLogs() {
        logs = [];
        updateLog();
      }

      async function setupServiceWorker() {
        if (!("serviceWorker" in navigator)) {
          log("Service Worker not supported", "error");
          return null;
        }

        try {
          const registration = await navigator.serviceWorker.register(
            "./zuzzuu-sw.js"
          );
          await navigator.serviceWorker.ready;
          log("‚úÖ Service Worker ready", "success");
          return registration;
        } catch (error) {
          log(
            `‚ùå Service Worker registration failed: ${error.message}`,
            "error"
          );
          return null;
        }
      }

      async function requestNotificationPermission() {
        if (!("Notification" in window)) {
          log("‚ùå Notifications not supported", "error");
          return false;
        }

        if (Notification.permission === "granted") {
          log("‚úÖ Notification permission already granted", "success");
          return true;
        }

        const permission = await Notification.requestPermission();
        if (permission === "granted") {
          log("‚úÖ Notification permission granted", "success");
          return true;
        } else {
          log("‚ùå Notification permission denied", "error");
          return false;
        }
      }

      async function testWithYourImageURL() {
        log("üß™ Testing with your Cloudinary image URL...", "info");

        const registration = await setupServiceWorker();
        if (!registration) return;

        const hasPermission = await requestNotificationPermission();
        if (!hasPermission) return;

        // Use the exact image URL from your example
        const testData = {
          type: "notification",
          data: {
            id: "test-your-image-" + Date.now(),
            title: "Boost Your Productivity",
            message:
              "üöÄ Boost Your Productivity! Unlock tips, tools, and habits to stay focused, work smarter, and achieve more every day. üíº‚ú®",
            image_url:
              "https://res.cloudinary.com/do5wahloo/image/upload/v1754142630/y17fdyg4c3hnpk0aolnw.jpg",
            logo_url:
              "https://res.cloudinary.com/do5wahloo/image/upload/v1746001971/zuzzuu/vhrhfihk5t6sawer0bhw.svg",
            url: "https://zuzzuu.com",
          },
        };

        if (registration.active) {
          registration.active.postMessage({
            type: "SIMULATE_WEBSOCKET_MESSAGE",
            data: testData,
          });
          log("üì§ Test message sent to service worker", "success");
        } else {
          log("‚ùå Service worker not active", "error");
        }
      }

      async function testWithDifferentImage() {
        log("üß™ Testing with different image URL...", "info");

        const registration = await setupServiceWorker();
        if (!registration) return;

        const hasPermission = await requestNotificationPermission();
        if (!hasPermission) return;

        const testData = {
          type: "notification",
          data: {
            id: "test-different-image-" + Date.now(),
            title: "Test Different Image",
            message: "Testing with a different image to verify image handling",
            image_url:
              "https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=400&h=200&fit=crop",
            logo_url:
              "https://res.cloudinary.com/do5wahloo/image/upload/v1746001971/zuzzuu/vhrhfihk5t6sawer0bhw.svg",
            url: "https://example.com",
          },
        };

        if (registration.active) {
          registration.active.postMessage({
            type: "SIMULATE_WEBSOCKET_MESSAGE",
            data: testData,
          });
          log("üì§ Different image test sent to service worker", "success");
        }
      }

      async function testWithoutImage() {
        log("üß™ Testing without image URL...", "info");

        const registration = await setupServiceWorker();
        if (!registration) return;

        const hasPermission = await requestNotificationPermission();
        if (!hasPermission) return;

        const testData = {
          type: "notification",
          data: {
            id: "test-no-image-" + Date.now(),
            title: "Test Without Image",
            message: "This notification should work without any image",
            logo_url:
              "https://res.cloudinary.com/do5wahloo/image/upload/v1746001971/zuzzuu/vhrhfihk5t6sawer0bhw.svg",
            url: "https://example.com",
          },
        };

        if (registration.active) {
          registration.active.postMessage({
            type: "SIMULATE_WEBSOCKET_MESSAGE",
            data: testData,
          });
          log("üì§ No-image test sent to service worker", "success");
        }
      }

      // Listen for service worker messages
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.addEventListener("message", (event) => {
          log(`üì® SW Message: ${event.data.type}`, "info");
        });
      }

      // Initial setup
      document.addEventListener("DOMContentLoaded", () => {
        log("üöÄ Final image fix test page loaded", "info");

        if ("serviceWorker" in navigator && "Notification" in window) {
          log("‚úÖ All APIs supported", "success");
        } else {
          log("‚ùå Some APIs not supported", "error");
        }
      });
    </script>
  </body>
</html>
