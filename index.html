<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zuzzuu Notification System - Control Panel</title>
    <link
      rel="icon"
      href="https://res.cloudinary.com/do5wahloo/image/upload/v1746001971/zuzzuu/vhrhfihk5t6sawer0bhw.svg"
      type="image/svg+xml"
    />

    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

    <script src="zuzzuu-notification.js"></script>
    <script src="zuzzuu-subscriber.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 16px;
      }

      @media (min-width: 768px) {
        .container {
          padding: 20px;
        }
      }

      @media (min-width: 1200px) {
        .container {
          padding: 24px;
        }
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        color: white;
      }

      .header h1 {
        font-size: 1.8rem;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      @media (min-width: 768px) {
        .header h1 {
          font-size: 2.2rem;
          gap: 15px;
        }
      }

      @media (min-width: 1200px) {
        .header h1 {
          font-size: 2.5rem;
        }
      }

      .header .logo {
        width: 40px;
        height: 40px;
        background: white;
        border-radius: 10px;
        padding: 6px;
        flex-shrink: 0;
      }

      @media (min-width: 768px) {
        .header .logo {
          width: 45px;
          height: 45px;
          border-radius: 12px;
          padding: 7px;
        }
      }

      @media (min-width: 1200px) {
        .header .logo {
          width: 50px;
          height: 50px;
          padding: 8px;
        }
      }

      .header p {
        font-size: 0.95rem;
        opacity: 0.9;
        text-align: center;
        line-height: 1.4;
        margin: 0 10px;
      }

      @media (min-width: 768px) {
        .header p {
          font-size: 1.05rem;
        }
      }

      @media (min-width: 1200px) {
        .header p {
          font-size: 1.1rem;
        }
      }

      .dashboard {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 30px;
      }

      @media (min-width: 769px) {
        .dashboard {
          grid-template-columns: 1fr;
        }
      }

      @media (min-width: 1200px) {
        .dashboard {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: white;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      @media (min-width: 768px) {
        .card {
          border-radius: 14px;
          padding: 20px;
          box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
        }
      }

      @media (min-width: 1200px) {
        .card {
          border-radius: 16px;
          padding: 25px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
      }

      .card h2 {
        font-size: 1.2rem;
        margin-bottom: 16px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      @media (min-width: 768px) {
        .card h2 {
          font-size: 1.3rem;
          margin-bottom: 18px;
          gap: 10px;
        }
      }

      @media (min-width: 1200px) {
        .card h2 {
          font-size: 1.4rem;
          margin-bottom: 20px;
        }
      }

      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        animation: pulse 2s infinite;
      }

      .status-connected {
        background: #10b981;
      }

      .status-connecting {
        background: #f59e0b;
      }

      .status-disconnected {
        background: #ef4444;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
      }

      @media (max-width: 480px) {
        .status-grid {
          grid-template-columns: 1fr;
          gap: 10px;
        }
      }

      @media (min-width: 481px) and (max-width: 768px) {
        .status-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      .status-item {
        background: #f8fafc;
        padding: 15px;
        border-radius: 12px;
        border-left: 4px solid #6366f1;
      }

      .status-item h3 {
        font-size: 0.9rem;
        color: #64748b;
        margin-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-item p {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1e293b;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 20px;
      }

      @media (max-width: 768px) {
        .controls {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
          gap: 10px;
        }
      }

      @media (max-width: 480px) {
        .controls {
          grid-template-columns: 1fr;
          gap: 12px;
        }
      }

      .btn {
        padding: 12px 16px;
        border: none;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        text-decoration: none;
        white-space: nowrap;
        min-height: 44px;
        text-align: center;
      }

      @media (max-width: 768px) {
        .btn {
          padding: 14px 18px;
          font-size: 0.9rem;
          min-height: 48px;
        }
      }

      @media (max-width: 480px) {
        .btn {
          padding: 16px 20px;
          font-size: 0.95rem;
          min-height: 52px;
          border-radius: 10px;
        }
      }

      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn-primary {
        background: #6366f1;
        color: white;
      }

      .btn-success {
        background: #10b981;
        color: white;
      }

      .btn-warning {
        background: #f59e0b;
        color: white;
      }

      .btn-danger {
        background: #ef4444;
        color: white;
      }

      .btn-secondary {
        background: #64748b;
        color: white;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .log-container {
        background: #1e293b;
        border-radius: 10px;
        padding: 12px;
        max-height: 300px;
        overflow-y: auto;
        font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
        font-size: 0.8rem;
        line-height: 1.4;
      }

      @media (min-width: 768px) {
        .log-container {
          border-radius: 12px;
          padding: 16px;
          max-height: 350px;
          font-size: 0.85rem;
          line-height: 1.5;
        }
      }

      @media (min-width: 1200px) {
        .log-container {
          padding: 20px;
          max-height: 400px;
        }
      }

      .log-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
        gap: 8px;
        flex-wrap: wrap;
      }

      @media (min-width: 768px) {
        .log-header {
          align-items: center;
          margin-bottom: 15px;
          gap: 10px;
          flex-wrap: nowrap;
        }
      }

      .log-controls {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        align-items: center;
      }

      @media (min-width: 768px) {
        .log-controls {
          gap: 10px;
        }
      }

      .log-entry {
        margin-bottom: 8px;
        padding: 8px 12px;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.05);
        border-left: 3px solid #6366f1;
      }

      .log-timestamp {
        color: #94a3b8;
        font-size: 0.8rem;
      }

      .log-level-info {
        border-left-color: #3b82f6;
      }

      .log-level-success {
        border-left-color: #10b981;
      }

      .log-level-warning {
        border-left-color: #f59e0b;
      }

      .log-level-error {
        border-left-color: #ef4444;
      }

      .log-message {
        color: #e2e8f0;
        margin-top: 4px;
      }

      .toast {
        position: fixed;
        top: 10px;
        right: 10px;
        background: white;
        border-radius: 10px;
        padding: 12px 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        z-index: 10000;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        max-width: calc(100vw - 20px);
        border-left: 4px solid #6366f1;
      }

      @media (min-width: 768px) {
        .toast {
          top: 20px;
          right: 20px;
          border-radius: 12px;
          padding: 16px 20px;
          max-width: 400px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
      }

      .toast.show {
        transform: translateX(0);
      }

      .toast-success {
        border-left-color: #10b981;
      }

      .toast-warning {
        border-left-color: #f59e0b;
      }

      .toast-error {
        border-left-color: #ef4444;
      }

      .toast-title {
        font-weight: 600;
        margin-bottom: 4px;
      }

      .toast-message {
        color: #64748b;
        font-size: 0.9rem;
      }

      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 12px;
        margin-top: 20px;
      }

      @media (max-width: 480px) {
        .metrics {
          grid-template-columns: repeat(3, 1fr);
          gap: 8px;
        }
      }

      .metric {
        text-align: center;
        padding: 12px;
        background: #f8fafc;
        border-radius: 10px;
      }

      @media (min-width: 768px) {
        .metric {
          padding: 15px;
          border-radius: 12px;
        }
      }

      .metric-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #6366f1;
        margin-bottom: 4px;
      }

      @media (min-width: 768px) {
        .metric-value {
          font-size: 1.8rem;
          margin-bottom: 5px;
        }
      }

      @media (min-width: 1200px) {
        .metric-value {
          font-size: 2rem;
        }
      }

      .metric-label {
        font-size: 0.75rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        line-height: 1.2;
      }

      @media (min-width: 768px) {
        .metric-label {
          font-size: 0.8rem;
        }
      }

      .environment-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .env-development {
        background: #fef3c7;
        color: #92400e;
      }

      .env-production {
        background: #dcfce7;
        color: #166534;
      }

      .env-staging {
        background: #e0e7ff;
        color: #3730a3;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
      }

      .checkbox-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
      }

      .full-width {
        grid-column: 1 / -1;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <h1>
          <img
            src="https://res.cloudinary.com/do5wahloo/image/upload/v1746001971/zuzzuu/vhrhfihk5t6sawer0bhw.svg"
            alt="Zuzzuu"
            class="logo"
          />
          Zuzzuu Notification System
        </h1>
        <p>Real-time notification management and monitoring dashboard</p>
      </div>

      <!-- Dashboard Grid -->
      <div class="dashboard">
        <!-- System Status Card -->
        <div class="card">
          <h2>
            <span class="status-indicator" id="systemStatus"></span>
            System Status
          </h2>

          <div class="status-grid">
            <div class="status-item">
              <h3>Environment</h3>
              <p id="environmentStatus">
                <span class="environment-badge" id="envBadge"
                  >Detecting...</span
                >
              </p>
            </div>
            <div class="status-item">
              <h3>Socket.IO</h3>
              <p id="socketStatus">Disconnected</p>
            </div>
            <div class="status-item">
              <h3>Service Worker</h3>
              <p id="serviceWorkerStatus">Not Available</p>
            </div>
            <div class="status-item">
              <h3>Browser Notifications</h3>
              <p id="notificationPermissionStatus">Not Requested</p>
            </div>
            <div class="status-item">
              <h3>Subscriber ID</h3>
              <p id="subscriberIdStatus">Not Set</p>
            </div>
          </div>

          <div class="controls">
            <button class="btn btn-primary" id="connectBtn">
              <span id="connectBtnText">Connect</span>
              <span
                class="loading"
                id="connectLoading"
                style="display: none"
              ></span>
            </button>
            <button class="btn btn-danger" id="disconnectBtn" disabled>
              Disconnect
            </button>
            <button class="btn btn-secondary" id="registerSwBtn">
              Register Service Worker
            </button>
            <button class="btn btn-success" id="enableNotificationsBtn">
              Enable Browser Notifications
            </button>
            <button class="btn btn-warning" id="testNotificationBtn">
              Test Notification
            </button>
            <button
              class="btn btn-secondary"
              id="testPushBtn"
              style="display: none"
            >
              Test Push Notification
            </button>
          </div>

          <div class="metrics">
            <div class="metric">
              <div class="metric-value" id="connectionsCount">0</div>
              <div class="metric-label">Connections</div>
            </div>
            <div class="metric">
              <div class="metric-value" id="notificationsCount">0</div>
              <div class="metric-label">Notifications</div>
            </div>
            <div class="metric">
              <div class="metric-value" id="uptimeCount">0s</div>
              <div class="metric-label">Uptime</div>
            </div>
          </div>
        </div>
      </div>

      <!-- System Log Card (Full Width) -->
      <div class="card full-width">
        <div class="log-header">
          <h2>📋 System Log</h2>
          <div class="log-controls">
            <button class="btn btn-secondary" id="clearLogBtn">
              Clear Log
            </button>
            <button class="btn btn-secondary" id="exportLogBtn">
              Export Log
            </button>
            <div class="checkbox-group">
              <input type="checkbox" id="autoScrollCheckbox" checked />
              <label for="autoScrollCheckbox">Auto-scroll</label>
            </div>
          </div>
        </div>
        <div class="log-container" id="logContainer">
          <div class="log-entry log-level-info">
            <div class="log-timestamp" id="initialTimestamp"></div>
            <div class="log-message">
              🚀 Zuzzuu Notification System initialized
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global state management
      const ZuzzuuDashboard = {
        // State
        state: {
          connected: false,
          connecting: false,
          socket: null,
          subscriberId: null,
          serviceWorkerRegistered: false,
          notificationCount: 0,
          connectionCount: 0,
          startTime: Date.now(),
          environment: "development",
          autoScroll: true,
          logs: [],
        },

        // Get Socket.IO URL based on environment
        getSocketIOUrl() {
          const hostname = window.location.hostname;
          const protocol = window.location.protocol;

          // Production environment
          if (hostname !== "localhost" && hostname !== "127.0.0.1") {
            return "https://vibte.shop";
          }

          // Development environment - always use localhost:8002 for the API server
          // This ensures it works whether accessed via localhost or 127.0.0.1
          return "http://localhost:8002";
        },

        // Get API base URL
        getApiBaseUrl() {
          const hostname = window.location.hostname;
          const protocol = window.location.protocol;

          // Production environment
          if (hostname !== "localhost" && hostname !== "127.0.0.1") {
            return "https://vibte.shop/api/v1";
          }

          // Development environment - always use localhost:8002 for consistency
          return "http://localhost:8002/api/v1";
        },

        // Initialize dashboard
        init() {
          this.log("info", "🚀 Initializing Zuzzuu Dashboard...");
          this.detectEnvironment();
          this.setupEventListeners();
          this.loadStoredData();
          this.checkServiceWorker();
          this.checkNotificationPermission();
          this.updateUI();
          this.startUptimeCounter();
          this.setInitialTimestamp();
          this.log("success", "✅ Dashboard initialized successfully");

          // Register subscriber with backend before connecting
          setTimeout(() => {
            this.log("info", "📝 Registering subscriber with backend...");
            this.registerSubscriber()
              .then(() => {
                this.log("info", "🔄 Auto-connecting to Socket.IO...");
                this.connect();
                // Initialize notification system with push support
                this.initializeNotificationSystem();
              })
              .catch((error) => {
                this.log(
                  "error",
                  `❌ Subscriber registration failed: ${error.message}`
                );
                // Still attempt to connect even if registration fails
                this.log("info", "🔄 Auto-connecting to Socket.IO anyway...");
                this.connect();
                // Still initialize notification system
                this.initializeNotificationSystem();
              });
          }, 1000); // Wait 1 second after initialization to ensure everything is ready
        },

        // Set initial timestamp
        setInitialTimestamp() {
          const timestamp = new Date().toLocaleTimeString();
          document.getElementById("initialTimestamp").textContent = timestamp;
        },

        // Register subscriber with backend
        async registerSubscriber() {
          try {
            if (!this.state.subscriberId) {
              throw new Error("No subscriber ID available");
            }

            const registrationData = {
              subscriber_id: this.state.subscriberId,
              browser: this.getBrowserInfo(),
              operating_system: this.getOSInfo(),
              country: this.getCountryInfo(),
              language: navigator.language || "en-US",
              status: "active",
              metadata: {
                environment: this.state.environment,
                user_agent: navigator.userAgent,
                screen_resolution: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                registration_source: "dashboard",
              },
            };

            const apiUrl = `${this.getApiBaseUrl()}/public/register`;
            this.log("info", `📡 Registering subscriber at: ${apiUrl}`);

            const response = await fetch(apiUrl, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "User-Agent": navigator.userAgent,
              },
              body: JSON.stringify(registrationData),
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(
                `Registration failed: ${response.status} - ${errorText}`
              );
            }

            const result = await response.json();
            this.log(
              "success",
              "✅ Subscriber registered successfully",
              result
            );

            // Update local storage with registration info
            localStorage.setItem("zuzzuu_registration_status", "registered");
            localStorage.setItem(
              "zuzzuu_registration_time",
              new Date().toISOString()
            );

            this.showToast(
              "Registration Complete",
              "Subscriber registered with backend",
              "success"
            );

            return result;
          } catch (error) {
            this.log("error", `📝 Registration failed: ${error.message}`);
            this.showToast("Registration Failed", error.message, "error");
            throw error;
          }
        },

        // Get browser info
        getBrowserInfo() {
          const userAgent = navigator.userAgent;
          if (userAgent.includes("Chrome")) return "Chrome";
          if (userAgent.includes("Firefox")) return "Firefox";
          if (userAgent.includes("Safari")) return "Safari";
          if (userAgent.includes("Edge")) return "Edge";
          if (userAgent.includes("Opera")) return "Opera";
          return "Unknown";
        },

        // Get OS info
        getOSInfo() {
          const userAgent = navigator.userAgent;
          if (userAgent.includes("Windows")) return "Windows";
          if (userAgent.includes("Mac")) return "macOS";
          if (userAgent.includes("Linux")) return "Linux";
          if (userAgent.includes("Android")) return "Android";
          if (userAgent.includes("iOS")) return "iOS";
          return "Unknown";
        },

        // Get country info (simplified - you might want to use a GeoIP service)
        getCountryInfo() {
          // This is a simple fallback - in production you'd use a GeoIP service
          const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
          if (timezone.includes("America")) return "US";
          if (timezone.includes("Europe")) return "EU";
          if (timezone.includes("Asia")) return "AS";
          return "Unknown";
        },

        // Environment detection
        detectEnvironment() {
          const hostname = window.location.hostname;
          const port = window.location.port;

          if (hostname === "localhost" || hostname === "127.0.0.1") {
            this.state.environment = "development";
          } else if (
            hostname.includes("staging") ||
            hostname.includes("test")
          ) {
            this.state.environment = "staging";
          } else {
            this.state.environment = "production";
          }

          this.log(
            "info",
            `🌍 Environment detected: ${this.state.environment} (${hostname}:${port})`
          );
        },

        // Setup event listeners
        setupEventListeners() {
          // Connection controls
          document
            .getElementById("connectBtn")
            .addEventListener("click", () => this.connect());
          document
            .getElementById("disconnectBtn")
            .addEventListener("click", () => this.disconnect());
          document
            .getElementById("registerSwBtn")
            .addEventListener("click", () => this.registerServiceWorker());
          document
            .getElementById("testNotificationBtn")
            .addEventListener("click", () => this.testNotification());
          document
            .getElementById("enableNotificationsBtn")
            .addEventListener("click", () => this.enableBrowserNotifications());
          document
            .getElementById("testPushBtn")
            .addEventListener("click", () => this.testPushNotification());

          // Log controls
          document
            .getElementById("clearLogBtn")
            .addEventListener("click", () => this.clearLog());
          document
            .getElementById("exportLogBtn")
            .addEventListener("click", () => this.exportLog());
          document
            .getElementById("autoScrollCheckbox")
            .addEventListener("change", (e) => {
              this.state.autoScroll = e.target.checked;
            });

          // Firebase-style service worker message handling
          if ("serviceWorker" in navigator) {
            navigator.serviceWorker.addEventListener("message", (event) => {
              this.handleServiceWorkerMessage(event);
            });
          }

          // Network status
          window.addEventListener("online", () => {
            this.log("success", "🌐 Network connection restored");
            this.showToast(
              "Network Online",
              "Internet connection restored",
              "success"
            );
          });

          window.addEventListener("offline", () => {
            this.log("warning", "🌐 Network connection lost");
            this.showToast(
              "Network Offline",
              "Internet connection lost",
              "warning"
            );
          });

          // Visibility change
          document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "visible") {
              this.log("info", "👁️ Page became visible");
            } else {
              this.log("info", "👁️ Page became hidden");
            }
          });
        },

        // Load stored data
        loadStoredData() {
          this.state.subscriberId = localStorage.getItem(
            "zuzzuu_subscriber_id"
          );
          if (this.state.subscriberId) {
            this.log(
              "info",
              `📱 Loaded subscriber ID: ${this.state.subscriberId.substring(
                0,
                8
              )}...`
            );
          } else {
            // Generate new subscriber ID
            this.state.subscriberId = this.generateSubscriberId();
            localStorage.setItem(
              "zuzzuu_subscriber_id",
              this.state.subscriberId
            );
            this.log(
              "info",
              `📱 Generated new subscriber ID: ${this.state.subscriberId.substring(
                0,
                8
              )}...`
            );
          }
        },

        // Generate subscriber ID
        generateSubscriberId() {
          return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(
            /[xy]/g,
            function (c) {
              const r = (Math.random() * 16) | 0;
              const v = c == "x" ? r : (r & 0x3) | 0x8;
              return v.toString(16);
            }
          );
        },

        // Check service worker
        async checkServiceWorker() {
          if ("serviceWorker" in navigator) {
            try {
              const registration =
                await navigator.serviceWorker.getRegistration();
              if (registration) {
                this.state.serviceWorkerRegistered = true;
                this.log("success", "👷 Service Worker is registered");
              } else {
                this.log("warning", "👷 Service Worker not registered");
              }
            } catch (error) {
              this.log(
                "error",
                `👷 Service Worker check failed: ${error.message}`
              );
            }
          } else {
            this.log("warning", "👷 Service Worker not supported");
          }
        },

        // Show test browser notification to confirm it works
        showTestBrowserNotification() {
          const testData = {
            id: "browser-test-" + Date.now(),
            title: "Notifications Enabled!",
            message:
              "Great! You will now receive browser notifications even when this page is closed.",
            logo_url:
              "https://res.cloudinary.com/do5wahloo/image/upload/v1746001971/zuzzuu/vhrhfihk5t6sawer0bhw.svg",
            timestamp: new Date().toISOString(),
          };

          if (window.zuzzuuNotification) {
            window.zuzzuuNotification.handleNotification(testData);
          }

          this.log(
            "success",
            "🔔 Test browser notification shown after permission grant"
          );
        },

        // Check notification permission
        async checkNotificationPermission() {
          if (typeof Notification === "undefined") {
            this.log(
              "warning",
              "🔔 Notifications not supported in this browser"
            );
            return;
          }

          const permission = Notification.permission;
          this.log("info", `🔔 Current notification permission: ${permission}`);

          if (permission === "granted") {
            this.log("success", "✅ Browser notifications are enabled");
          } else if (permission === "denied") {
            this.log("warning", "⚠️ Browser notifications are denied");
          } else {
            this.log("info", "🔔 Browser notifications not yet requested");
          }
        },

        // Enable browser notifications
        async enableBrowserNotifications() {
          if (typeof Notification === "undefined") {
            this.showToast(
              "Not Supported",
              "Browser notifications are not supported in this browser",
              "error"
            );
            return;
          }

          if (Notification.permission === "granted") {
            this.showToast(
              "Already Enabled",
              "Browser notifications are already enabled",
              "success"
            );
            this.updateUI();
            return;
          }

          if (Notification.permission === "denied") {
            this.showToast(
              "Permission Denied",
              "Browser notifications have been denied. Please enable them manually in browser settings.",
              "error"
            );
            this.log(
              "warning",
              "⚠️ Cannot request permission - already denied"
            );
            return;
          }

          try {
            this.log("info", "🔔 Requesting notification permission...");

            // Show loading state
            const btn = document.getElementById("enableNotificationsBtn");
            const originalText = btn.textContent;
            btn.textContent = "Requesting Permission...";
            btn.disabled = true;

            const permission = await Notification.requestPermission();

            this.log("info", `🔔 Permission request result: ${permission}`);

            if (permission === "granted") {
              this.log("success", "✅ Browser notification permission granted");
              this.showToast(
                "Permission Granted",
                "Browser notifications have been enabled successfully",
                "success"
              );

              // Set up push notifications now that permission is granted
              if (
                window.zuzzuuNotification &&
                window.zuzzuuNotification.setupPushNotifications
              ) {
                window.zuzzuuNotification
                  .setupPushNotifications()
                  .then(() => {
                    this.log(
                      "success",
                      "✅ Push notifications set up successfully after permission grant"
                    );
                  })
                  .catch((error) => {
                    this.log(
                      "error",
                      `❌ Push notification setup failed: ${error.message}`
                    );
                  });
              }

              // Store consent
              localStorage.setItem("zuzzuu_notification_consent", "true");
              localStorage.removeItem("zuzzuu_notification_rejected");

              // Show a test notification to confirm it works
              setTimeout(() => {
                this.showTestBrowserNotification();
              }, 1000);
            } else if (permission === "denied") {
              this.log("warning", "⚠️ Browser notification permission denied");
              this.showToast(
                "Permission Denied",
                "Browser notifications have been denied. Please enable them manually in browser settings.",
                "error"
              );

              // Store rejection
              localStorage.setItem("zuzzuu_notification_rejected", "true");
              localStorage.removeItem("zuzzuu_notification_consent");
            } else {
              this.log(
                "warning",
                "⚠️ Notification permission request returned default/unknown"
              );
              this.showToast(
                "Permission Request",
                "Permission request completed but status is unclear. Please try again.",
                "warning"
              );
            }

            // Reset button state
            btn.textContent = originalText;
            btn.disabled = false;
            this.updateUI();
          } catch (error) {
            this.log(
              "error",
              `❌ Error requesting notification permission: ${error.message}`
            );
            this.showToast(
              "Permission Error",
              `Failed to request notification permission: ${error.message}`,
              "error"
            );

            // Reset button state
            const btn = document.getElementById("enableNotificationsBtn");
            btn.textContent = "Enable Browser Notifications";
            btn.disabled = false;
          }
        },

        // Register service worker (enhanced with Firebase-style auto push setup)
        async registerServiceWorker() {
          if (!("serviceWorker" in navigator)) {
            this.showToast(
              "Not Supported",
              "Service Worker not supported in this browser",
              "error"
            );
            return;
          }

          try {
            this.log("info", "👷 Registering Service Worker...");
            const registration = await navigator.serviceWorker.register(
              "zuzzuu-sw.js"
            );
            this.state.serviceWorkerRegistered = true;
            this.log("success", "👷 Service Worker registered successfully");

            // Firebase-style: Automatically set up push notifications after SW registration
            await this.autoSetupPushNotifications(registration);

            this.showToast(
              "Service Worker",
              "Successfully registered with push support",
              "success"
            );
            this.updateUI();
          } catch (error) {
            this.log(
              "error",
              `👷 Service Worker registration failed: ${error.message}`
            );
            this.showToast("Registration Failed", error.message, "error");
          }
        },

        // Auto setup push notifications (Firebase-style approach)
        async autoSetupPushNotifications(registration) {
          try {
            this.log("info", "🔔 Auto-setting up push notifications...");

            // Check if notifications are supported
            if (!("Notification" in window)) {
              this.log(
                "warning",
                "⚠️ This browser does not support notifications"
              );
              return;
            }

            // Check current permission
            let permission = Notification.permission;

            if (permission === "default") {
              this.log("info", "🔔 Requesting notification permission...");
              permission = await Notification.requestPermission();
            }

            if (permission === "granted") {
              this.log("success", "✅ Notification permission granted");

              // Initialize notification system if not already done
              if (!window.zuzzuuNotification) {
                this.initializeNotificationSystem();
              }

              // Set up push subscription (Firebase-style)
              if (
                window.zuzzuuNotification &&
                window.zuzzuuNotification.setupPushNotifications
              ) {
                await window.zuzzuuNotification.setupPushNotifications();
                this.log(
                  "success",
                  "✅ Push notifications configured successfully"
                );

                // Show a test notification to confirm it's working
                if (registration) {
                  await registration.showNotification(
                    "Zuzzuu Notifications Ready",
                    {
                      body: "Push notifications are now active! You'll receive notifications even when the browser is closed.",
                      icon: "https://res.cloudinary.com/do5wahloo/image/upload/v1746001971/zuzzuu/vhrhfihk5t6sawer0bhw.svg",
                      badge:
                        "https://res.cloudinary.com/do5wahloo/image/upload/v1746001971/zuzzuu/vhrhfihk5t6sawer0bhw.svg",
                      tag: "zuzzuu-setup-complete",
                      requireInteraction: false,
                      silent: false,
                    }
                  );
                  this.log(
                    "success",
                    "✅ Setup confirmation notification shown"
                  );
                }
              }
            } else if (permission === "denied") {
              this.log(
                "warning",
                "⚠️ Notification permission denied - push notifications disabled"
              );
            } else {
              this.log("info", "ℹ️ Notification permission not determined");
            }
          } catch (error) {
            this.log("error", `❌ Auto push setup failed: ${error.message}`);
            // Don't throw error, just log it - service worker should still work
          }
        },

        // Connect to Socket.IO
        async connect() {
          if (this.state.connecting || this.state.connected) {
            return;
          }

          this.state.connecting = true;
          this.updateUI();
          this.log("info", "🔌 Connecting to Socket.IO...");

          try {
            // Use the getSocketIOUrl method to determine the correct URL
            const socketUrl = this.getSocketIOUrl();
            this.log("info", `🔗 Connecting to: ${socketUrl}`);

            this.state.socket = io(socketUrl, {
              query: {
                subscriber_id: this.state.subscriberId,
                client_type: "dashboard_connection",
                timestamp: Date.now(),
              },
              transports: ["websocket", "polling"],
              timeout: 20000,
              forceNew: true,
              reconnection: true,
              reconnectionDelay: 1000,
              reconnectionAttempts: 5,
              maxReconnectionAttempts: 5,
            });

            // Connection events
            this.state.socket.on("connect", () => {
              this.state.connected = true;
              this.state.connecting = false;
              this.state.connectionCount++;
              this.log(
                "success",
                `✅ Connected to Socket.IO (ID: ${this.state.socket.id})`
              );
              this.showToast(
                "Connected",
                "Socket.IO connection established",
                "success"
              );
              this.updateUI();
            });

            this.state.socket.on("disconnect", (reason) => {
              this.state.connected = false;
              this.state.connecting = false;
              this.log("warning", `❌ Disconnected from Socket.IO: ${reason}`);
              this.showToast(
                "Disconnected",
                `Connection lost: ${reason}`,
                "warning"
              );
              this.updateUI();
            });

            this.state.socket.on("connect_error", (error) => {
              this.state.connected = false;
              this.state.connecting = false;
              this.log("error", `⚠️ Connection error: ${error.message}`);
              this.showToast("Connection Error", error.message, "error");
              this.updateUI();
            });

            // Custom events
            this.state.socket.on("connection_established", (data) => {
              this.log(
                "success",
                "🎉 Connection established event received",
                data
              );
            });

            this.state.socket.on("subscriber_registered", (data) => {
              this.log(
                "success",
                "📝 Subscriber registered successfully",
                data
              );
            });

            this.state.socket.on("notification", (data) => {
              this.state.notificationCount++;
              this.log("info", "📧 Notification received via Socket.IO", data);
              this.handleNotification(data);
              this.updateUI();
            });

            // Set connection timeout
            setTimeout(() => {
              if (this.state.connecting && !this.state.connected) {
                this.log(
                  "warning",
                  "⏱️ Connection timeout - Socket.IO may still be connecting"
                );
                this.state.connecting = false;
                this.updateUI();
              }
            }, 20000);
          } catch (error) {
            this.state.connecting = false;
            this.log("error", `🔌 Connection failed: ${error.message}`);
            this.showToast("Connection Failed", error.message, "error");
            this.updateUI();
          }
        },

        // Disconnect from Socket.IO
        disconnect() {
          if (this.state.socket) {
            this.state.socket.disconnect();
            this.state.socket = null;
          }
          this.state.connected = false;
          this.state.connecting = false;
          this.log("info", "🔌 Disconnected from Socket.IO");
          this.updateUI();
        },

        // Handle received notification
        handleNotification(data) {
          // Initialize ZuzzuuNotification if not already done
          if (!window.zuzzuuNotification) {
            window.zuzzuuNotification = new ZuzzuuNotification({
              debug: true,
              autoConnect: false,
              socketUrl: this.getSocketIOUrl(), // Use the same URL detection logic
              apiUrl: this.getApiBaseUrl(),
              vapidPublicKey: null, // Will be set by server if needed
            });
          }

          // Handle the notification
          window.zuzzuuNotification.handleNotification(data);
        },

        // Test notification
        testNotification() {
          const testData = {
            id: Date.now(),
            title: "Test Notification",
            message: "This is a test notification from the Zuzzuu dashboard!",
            logo_url:
              "https://res.cloudinary.com/do5wahloo/image/upload/v1746001971/zuzzuu/vhrhfihk5t6sawer0bhw.svg",
            url: window.location.href,
            timestamp: new Date().toISOString(),
          };

          this.state.notificationCount++;
          this.log("info", "🧪 Sending test notification", testData);
          this.handleNotification(testData);
          this.showToast("Test Sent", "Test notification displayed", "success");
          this.updateUI();
        },

        // Update UI
        updateUI() {
          // System status indicator
          const statusIndicator = document.getElementById("systemStatus");
          if (this.state.connected) {
            statusIndicator.className = "status-indicator status-connected";
          } else if (this.state.connecting) {
            statusIndicator.className = "status-indicator status-connecting";
          } else {
            statusIndicator.className = "status-indicator status-disconnected";
          }

          // Environment badge
          const envBadge = document.getElementById("envBadge");
          envBadge.textContent = this.state.environment;
          envBadge.className = `environment-badge env-${this.state.environment}`;

          // Status text updates
          document.getElementById("socketStatus").textContent = this.state
            .connected
            ? "Connected"
            : this.state.connecting
            ? "Connecting..."
            : "Disconnected";

          document.getElementById("serviceWorkerStatus").textContent = this
            .state.serviceWorkerRegistered
            ? "Registered"
            : "Not Registered";

          document.getElementById("subscriberIdStatus").textContent = this.state
            .subscriberId
            ? `${this.state.subscriberId.substring(0, 8)}...`
            : "Not Set";

          // Update notification permission status
          const notificationPermissionStatus = document.getElementById(
            "notificationPermissionStatus"
          );
          if (notificationPermissionStatus) {
            if (typeof Notification === "undefined") {
              notificationPermissionStatus.textContent = "Not Supported";
            } else {
              const permission = Notification.permission;
              switch (permission) {
                case "granted":
                  notificationPermissionStatus.textContent = "Granted";
                  document.getElementById("testPushBtn").style.display =
                    "inline-flex";
                  document.getElementById(
                    "enableNotificationsBtn"
                  ).style.display = "none";
                  break;
                case "denied":
                  notificationPermissionStatus.textContent = "Denied";
                  document.getElementById("testPushBtn").style.display = "none";
                  document.getElementById(
                    "enableNotificationsBtn"
                  ).textContent = "Permission Denied";
                  document.getElementById(
                    "enableNotificationsBtn"
                  ).disabled = true;
                  break;
                case "default":
                default:
                  notificationPermissionStatus.textContent = "Not Requested";
                  document.getElementById("testPushBtn").style.display = "none";
                  document.getElementById(
                    "enableNotificationsBtn"
                  ).style.display = "inline-flex";
                  document.getElementById(
                    "enableNotificationsBtn"
                  ).disabled = false;
                  document.getElementById(
                    "enableNotificationsBtn"
                  ).textContent = "Enable Browser Notifications";
                  break;
              }
            }
          }

          // Button states
          const connectBtn = document.getElementById("connectBtn");
          const disconnectBtn = document.getElementById("disconnectBtn");
          const connectBtnText = document.getElementById("connectBtnText");
          const connectLoading = document.getElementById("connectLoading");

          if (this.state.connecting) {
            connectBtn.disabled = true;
            connectBtnText.style.display = "none";
            connectLoading.style.display = "inline-block";
            disconnectBtn.disabled = true;
          } else if (this.state.connected) {
            connectBtn.disabled = true;
            connectBtnText.style.display = "inline";
            connectLoading.style.display = "none";
            disconnectBtn.disabled = false;
          } else {
            connectBtn.disabled = false;
            connectBtnText.style.display = "inline";
            connectLoading.style.display = "none";
            disconnectBtn.disabled = true;
          }

          // Metrics
          document.getElementById("connectionsCount").textContent =
            this.state.connectionCount;
          document.getElementById("notificationsCount").textContent =
            this.state.notificationCount;
        },

        // Start uptime counter
        startUptimeCounter() {
          setInterval(() => {
            const uptime = Math.floor(
              (Date.now() - this.state.startTime) / 1000
            );
            const hours = Math.floor(uptime / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            const seconds = uptime % 60;

            let uptimeText = "";
            if (hours > 0) {
              uptimeText = `${hours}h ${minutes}m ${seconds}s`;
            } else if (minutes > 0) {
              uptimeText = `${minutes}m ${seconds}s`;
            } else {
              uptimeText = `${seconds}s`;
            }

            document.getElementById("uptimeCount").textContent = uptimeText;
          }, 1000);
        },

        // Log function
        log(level, message, data = null) {
          const timestamp = new Date().toLocaleTimeString();
          const logEntry = {
            timestamp,
            level,
            message,
            data,
          };

          this.state.logs.push(logEntry);

          // Create log element
          const logElement = document.createElement("div");
          logElement.className = `log-entry log-level-${level}`;

          const timestampElement = document.createElement("div");
          timestampElement.className = "log-timestamp";
          timestampElement.textContent = timestamp;

          const messageElement = document.createElement("div");
          messageElement.className = "log-message";
          messageElement.textContent = data
            ? `${message} ${JSON.stringify(data)}`
            : message;

          logElement.appendChild(timestampElement);
          logElement.appendChild(messageElement);

          // Add to log container
          const logContainer = document.getElementById("logContainer");
          logContainer.appendChild(logElement);

          // Auto-scroll if enabled
          if (this.state.autoScroll) {
            logContainer.scrollTop = logContainer.scrollHeight;
          }

          // Keep only last 100 log entries
          if (this.state.logs.length > 100) {
            this.state.logs.shift();
            const firstLogElement = logContainer.firstElementChild;
            if (
              firstLogElement &&
              firstLogElement !==
                document.getElementById("initialTimestamp").parentElement
            ) {
              firstLogElement.remove();
            }
          }

          // Console log for debugging
          console.log(
            `[ZuzzuuDashboard] ${level.toUpperCase()}: ${message}`,
            data || ""
          );
        },

        // Show toast notification
        showToast(title, message, type = "info") {
          const toast = document.createElement("div");
          toast.className = `toast toast-${type}`;

          const titleElement = document.createElement("div");
          titleElement.className = "toast-title";
          titleElement.textContent = title;

          const messageElement = document.createElement("div");
          messageElement.className = "toast-message";
          messageElement.textContent = message;

          toast.appendChild(titleElement);
          toast.appendChild(messageElement);

          document.body.appendChild(toast);

          // Show toast
          setTimeout(() => toast.classList.add("show"), 100);

          // Hide toast after 4 seconds
          setTimeout(() => {
            toast.classList.remove("show");
            setTimeout(() => {
              if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
              }
            }, 300);
          }, 4000);
        },

        // Initialize notification system with push support
        initializeNotificationSystem() {
          if (!window.zuzzuuNotification) {
            window.zuzzuuNotification = new ZuzzuuNotification({
              debug: true,
              autoConnect: false,
              socketUrl: this.getSocketIOUrl(),
              apiUrl: this.getApiBaseUrl(),
              vapidPublicKey: null, // Will be set by server if needed
            });
          }

          // Set up push notifications
          if (
            window.zuzzuuNotification &&
            window.zuzzuuNotification.setupPushNotifications
          ) {
            window.zuzzuuNotification
              .setupPushNotifications()
              .then(() => {
                this.log(
                  "success",
                  "✅ Push notifications set up successfully"
                );
              })
              .catch((error) => {
                this.log(
                  "error",
                  `❌ Push notification setup failed: ${error.message}`
                );
              });
          }
        },

        // Test push notification functionality
        async testPushNotification() {
          if (
            !window.zuzzuuNotification ||
            !window.zuzzuuNotification.pushSubscription
          ) {
            this.log(
              "warning",
              "⚠️ Push subscription not available for testing"
            );
            this.showToast(
              "Push Not Ready",
              "Push subscription not available",
              "warning"
            );
            return;
          }

          try {
            // Send a test push notification via the server
            const testData = {
              subscriber_id: this.state.subscriberId,
              title: "Push Test Notification",
              message:
                "This is a test push notification sent when browser is closed!",
              url: window.location.href,
              logo_url:
                "https://res.cloudinary.com/do5wahloo/image/upload/v1746001971/zuzzuu/vhrhfihk5t6sawer0bhw.svg",
            };

            const response = await fetch(`${this.getApiBaseUrl()}/push/test`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(testData),
            });

            if (response.ok) {
              this.log("success", "✅ Test push notification sent to server");
              this.showToast(
                "Push Test Sent",
                "Test notification sent to server",
                "success"
              );
            } else {
              throw new Error(`Server responded with ${response.status}`);
            }
          } catch (error) {
            this.log(
              "error",
              `❌ Failed to send test push notification: ${error.message}`
            );
            this.showToast("Push Test Failed", error.message, "error");
          }
        },

        // Clear log
        clearLog() {
          this.state.logs = [];
          const logContainer = document.getElementById("logContainer");
          logContainer.innerHTML = `
                    <div class="log-entry log-level-info">
                        <div class="log-timestamp">${new Date().toLocaleTimeString()}</div>
                        <div class="log-message">🧹 Log cleared</div>
                    </div>
                `;
          this.log("info", "🧹 System log cleared");
        },

        // Export log
        exportLog() {
          const logData = this.state.logs
            .map(
              (entry) =>
                `[${entry.timestamp}] ${entry.level.toUpperCase()}: ${
                  entry.message
                }${entry.data ? " " + JSON.stringify(entry.data) : ""}`
            )
            .join("\n");

          const blob = new Blob([logData], { type: "text/plain" });
          const url = URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = `zuzzuu-log-${new Date()
            .toISOString()
            .slice(0, 19)
            .replace(/:/g, "-")}.txt`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);

          URL.revokeObjectURL(url);
          this.log("info", "📄 Log exported successfully");
          this.showToast("Export Complete", "Log file downloaded", "success");
        },

        // Handle service worker messages (Firebase-style)
        handleServiceWorkerMessage(event) {
          const { type, data } = event.data || {};

          switch (type) {
            case "PUSH_NOTIFICATION_RECEIVED":
              this.log(
                "info",
                "📱 Push notification received in main thread",
                data
              );
              this.handlePushNotificationReceived(data);
              break;

            case "NOTIFICATION_CLICKED":
              this.log("info", "🖱️ Push notification clicked", data);
              this.handleNotificationClicked(data);
              break;

            case "NOTIFICATION_CLOSED":
              this.log("info", "❌ Push notification closed", data);
              this.handleNotificationClosed(data);
              break;

            case "SERVICE_WORKER_READY":
              this.log(
                "success",
                "👷 Service worker ready and claiming clients"
              );
              break;

            default:
              this.log("info", `📨 Service worker message: ${type}`, data);
          }
        },

        // Handle push notification received (Firebase-style)
        handlePushNotificationReceived(notificationData) {
          try {
            // Log the notification for debugging
            this.log(
              "success",
              "✅ Push notification processed",
              notificationData
            );

            // Update UI if needed
            this.updateNotificationCounter();

            // Store notification in local history if desired
            this.storeNotificationInHistory(notificationData);
          } catch (error) {
            this.log(
              "error",
              `❌ Error handling push notification: ${error.message}`
            );
          }
        },

        // Handle notification click (Firebase-style)
        handleNotificationClicked(notificationData) {
          try {
            this.log(
              "info",
              "🖱️ Processing notification click",
              notificationData
            );

            // Track analytics if needed
            this.trackNotificationClick(notificationData);

            // Handle specific actions based on notification data
            if (notificationData.url) {
              this.log(
                "info",
                `🔗 Notification contained URL: ${notificationData.url}`
              );
            }
          } catch (error) {
            this.log(
              "error",
              `❌ Error handling notification click: ${error.message}`
            );
          }
        },

        // Handle notification close (Firebase-style)
        handleNotificationClosed(notificationData) {
          try {
            this.log(
              "info",
              "❌ Processing notification close",
              notificationData
            );

            // Track analytics if needed
            this.trackNotificationDismiss(notificationData);
          } catch (error) {
            this.log(
              "error",
              `❌ Error handling notification close: ${error.message}`
            );
          }
        },

        // Store notification in history
        storeNotificationInHistory(notificationData) {
          try {
            const notifications = JSON.parse(
              localStorage.getItem("zuzzuu_notification_history") || "[]"
            );
            notifications.unshift({
              ...notificationData,
              timestamp: new Date().toISOString(),
              status: "received",
            });

            // Keep only last 50 notifications
            if (notifications.length > 50) {
              notifications.splice(50);
            }

            localStorage.setItem(
              "zuzzuu_notification_history",
              JSON.stringify(notifications)
            );
          } catch (error) {
            this.log(
              "error",
              `❌ Error storing notification: ${error.message}`
            );
          }
        },

        // Update notification counter
        updateNotificationCounter() {
          // Implement notification counter UI update if needed
          // This is a placeholder for future enhancement
        },

        // Track notification click
        trackNotificationClick(notificationData) {
          // Implement analytics tracking if needed
          // This is a placeholder for future enhancement
        },

        // Track notification dismiss
        trackNotificationDismiss(notificationData) {
          // Implement analytics tracking if needed
          // This is a placeholder for future enhancement
        },
      };

      // Initialize dashboard when DOM is loaded
      document.addEventListener("DOMContentLoaded", () => {
        ZuzzuuDashboard.init();
      });

      // Make dashboard globally available
      window.ZuzzuuDashboard = ZuzzuuDashboard;
    </script>

    <!-- Automatic Service Worker Registration (Flutter-style) -->
    <script>
      // Automatically register service worker on page load (like Flutter web)
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function () {
          console.log('[Auto-SW] Registering service worker automatically...');
          
          navigator.serviceWorker.register('zuzzuu-sw.js', {
            scope: '/', // Use root scope for broader coverage
          })
          .then(function(registration) {
            console.log('[Auto-SW] Service Worker registered successfully:', registration);
            
            // Automatically request notification permission if not already granted
            if ('Notification' in window && Notification.permission === 'default') {
              console.log('[Auto-SW] Requesting notification permission...');
              Notification.requestPermission().then(function(permission) {
                console.log('[Auto-SW] Notification permission:', permission);
                if (permission === 'granted') {
                  // Show a welcome notification
                  registration.showNotification('Zuzzuu Notifications Active', {
                    body: 'Push notifications are now enabled! You\'ll receive notifications even when the browser is closed.',
                    icon: 'https://res.cloudinary.com/do5wahloo/image/upload/v1746001971/zuzzuu/vhrhfihk5t6sawer0bhw.svg',
                    badge: 'https://res.cloudinary.com/do5wahloo/image/upload/v1746001971/zuzzuu/vhrhfihk5t6sawer0bhw.svg',
                    tag: 'zuzzuu-auto-setup',
                    requireInteraction: false,
                    silent: false,
                    data: {
                      url: window.location.href,
                      source: 'auto-setup'
                    }
                  });
                }
              });
            }
          })
          .catch(function(error) {
            console.error('[Auto-SW] Service Worker registration failed:', error);
          });
        });
      } else {
        console.warn('[Auto-SW] Service Workers not supported in this browser');
      }
    </script>
  </body>
</html>
